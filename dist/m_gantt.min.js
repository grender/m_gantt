/*! m_gantt 2014-10-17 */

!function(a){"function"==typeof define&&define.amd?define(["jquery","moment"],a):a(jQuery,moment)}(function(a,b){function c(c,e){function f(){D=a("<div class='m_gantt'><div class='m_gantt-col-labels'></div><div class='m_gantt-col-center'><div class='m_gantt-grid-header'></div><div class='m_gantt-grid'></div></div><div class='m_gantt-col-sums'></div></div>"),c.append(D),C=!0}function g(){for(var a=0;a<v.length;a++)if(v[a].id=v[a].id||"bar"+a,v[a].text=v[a].text||"",v[a].hasChilds=!1,v[a].start=b.isMoment(v[a].start)?v[a].start:b(v[a].start),v[a].end=b.isMoment(v[a].end)?v[a].end:b(v[a].end),v[a].diff=v[a].end.diff(v[a].start,"days"),v[a].parent)for(var c=0;c<v.length;c++)if(v[c].id==v[a].parent){v[c].hasChilds?(v[c].start=b(b.min(v[c].start,v[a].start)),v[c].end=b(b.max(v[c].end,v[a].end))):(v[c].start=b(v[a].start),v[c].end=b(v[a].end),v[c].hasChilds=!0);break}}function h(){if(!u.beforeRender||u.beforeRender()!==!1){C||f(),D.find(".m_gantt-col-labels").empty(),D.find(".m_gantt-grid-header").empty(),D.find(".m_gantt-grid").empty(),D.find(".m_gantt-col-sums").empty();var c=0;c=u.height&&"auto"!=u.height&&u.height>0?u.height:D.width()*u.aspectRatio,D.height(c),D.find(".m_gantt-col-labels").width(u.labelsWidth),D.find(".m_gantt-col-center").width(D.width()-(D.find(".m_gantt-col-labels").width()+D.find(".m_gantt-col-sums").width()));for(var d=b(u.start).startOf("day"),e=b(u.end).startOf("day"),h=b(e).subtract(1,"days").startOf("day"),i=b(d).startOf("day"),o="",p="",q="",r=0,s=0;i.isBefore(e);)o+="<td>"+i.format("dd")+"</td>",p+="<td>"+i.format("D")+"</td>",s++,(1*i.format("D")==i.daysInMonth()||i.isSame(h))&&(q+="<td colspan='"+s+"'>"+i.format("MMMM YYYY")+"</td>",s=0),i.add(1,"days"),r++;D.find(".m_gantt-grid-header").append("<table><tr class='m_gantt-grid-header-dayofweek'>"+o+"</tr><tr class='m_gantt-grid-header-day'>"+p+"</tr><tr class='m_gantt-grid-header-month'>"+q+"</td></tr></table>").width(u.grid.width*r),D.find(".m_gantt-grid-header table").width(u.grid.width*r),D.find(".m_gantt-grid-header table").width(u.grid.width*r),D.find(".m_gantt-grid").width(u.grid.width*r).height(v.length*u.grid.height),x=D.find(".m_gantt-grid").data("opts",u.grid),g();for(var t=0;t<v.length;t++){var B=v[t],E="m_gantt-task";B.hasChilds&&(E="m_gantt-group");var F=a("<div class='"+E+"'>"+B.text+"</div>");if(B.nbUnitsToBeMade&&B.nbUnitsMade){var G=a("<div class='m_gantt-advance'></div>");F.append(G);var H=100*B.nbUnitsMade/B.nbUnitsToBeMade;H>=u.thresholdWarning&&H<u.thresholdDanger?G.addClass("warning"):H>=u.thresholdDanger&&100>H?G.addClass("danger"):H>100&&(u.advancesNotOverflow&&(H=100),G.addClass("danger")),G.width(H+"%")}B.hasChilds?(F.append(a("<div class='m_gantt-arrow-left'></div>")),F.append(a("<div class='m_gantt-arrow-right'></div>"))):F.append(a("<div class='m_gantt-resize'></div>")),F.data("id",B.id);var I=b(B.end).startOf("day").diff(b(B.start).startOf("day"),"days"),J=b(B.start).startOf("day").diff(d,"days");F.width(u.grid.width*I).height(u.grid.barHeight),x.append(F),F.css("top",t*u.grid.height+(u.grid.height-u.grid.barHeight)/2).css("left",u.grid.width*J),B.bgColor&&F.css("background-color",B.bgColor),B.hasChilds||(F.mousedown(function(b){b.preventDefault(),z="click";var c=a(b.target).closest(".m_gantt-task");y=c,A=b.pageX-c.offset().left,b.stopPropagation(),a(document).on("mouseup",j),a(document).on("mousemove",k)}),F.find(".m_gantt-resize").mousedown(function(b){var c=a(b.target).closest(".m_gantt-resize"),d=c.closest(".m_gantt-task");b.preventDefault(),b.stopPropagation(),y=d,A=b.pageX-c.offset().left,a(document).on("mouseup",l),a(document).on("mousemove",m)})),w[v[t].id]=F}n(),u.afterRender&&u.afterRender(v)}}function i(a){var c=x.offset().left,d=a-c,e=Math.round(d/32);return b(u.start).add(e,"days").startOf("day")}function j(){if(a(document).off("mouseup",j),a(document).off("mousemove",k),"move"==z)h();else{var b=r(y.data("id"));v[b].click&&v[b].click()}}function k(a){z="move";var c=y,d=a.pageX-A,e=x.offset().left,f=d-e;if(d-=f%32,c.offset({left:d}),B!=d){n();var g=r(c.data("id"));v[g].start=i(d),v[g].end=b(v[g].start).add(v[g].diff,"days")}B=d}function l(){a(document).off("mouseup",l),a(document).off("mousemove",m),h()}function m(a){var c=y,d=a.pageX-A,e=c.offset().left,f=d-e;if(f=f-f%32+32,c.width(f),B!=f){var g=r(c.data("id"));v[g].diff=Math.round(f/32),v[g].end=b(v[g].start).add(v[g].diff,"days"),n()}B=f}function n(){x.find(".m_gantt-link").remove();for(var b=0;b<v.length;b++){var c=v[b];if(c.links){var d=w[c.id];if(w[c.links]){var e=w[c.links],f=d.position().left+d.width(),g=d.position().top+10,h=e.position().left-d.position().left-d.width(),i=e.position().top-d.position().top,j=0,k=Math.ceil(h/3*2),l=0,m=h;20>h&&(f=e.position().left-40,h=-1*h+80,j=h-40,k=h,l=0,m=40);var n=!1;0>i&&(g=e.position().top+10,i=-1*i,n=!0);var o=a("<div class='m_gantt-link'><canvas width='"+h+"' height='"+(i+5)+"'></canvas></div>");x.append(o),o.css("left",f).css("top",g),o.width(h).height(i+5);var p=o.find("canvas").get(0).getContext("2d");n&&p.setTransform(1,0,0,-1,0,i),p.fillStyle="#000",p.strokeStyle="#000",p.lineWidth=2,p.beginPath(),p.moveTo(j,1),p.bezierCurveTo(k,0,l,i,m,i),p.stroke(),p.beginPath(),p.moveTo(m,i),p.lineTo(m-5,i-5),p.lineTo(m-5,i+5),p.fill()}}}}function o(){c.append(a("<div>Hello</div>"))}function p(a){v.push(a),h()}function q(a){for(var b=0;b<v.length;b++)if(v[b].id==a)return v[b];return null}function r(a){for(var b=0;b<v.length;b++)if(v[b].id==a)return b;return null}function s(a){for(var b=0;b<v.length;b++)if(v[b].id==a){v.splice(b,1);break}h()}var t=this,u=a.extend(!0,{},d,e);t.render=h,t.sayHello=o,t.addTask=p,t.removeTask=s,t.getTask=q,t.getIndexTask=r,t.opts=u;var v=u.values,w={},x=null,y=null,z="click",A=0,B=-1,C=!1,D=null}{var d={lang:"en",aspectRatio:.8,labelsWidth:0,firstDay:1,start:b(),end:b().add(3,"months"),values:[],thresholdWarning:70,thresholdDanger:90,advancesNotOverflow:!1,grid:{width:32,height:32,img:"m_gantt-bg.gif",barHeight:20}};a.m_gantt={version:"0.1.2"}}a.fn.m_gantt=function(b){var d=Array.prototype.slice.call(arguments,1),e=this;return this.each(function(f,g){var h,i=a(g),j=i.data("m_gantt");"string"==typeof b?j&&a.isFunction(j[b])&&(h=j[b].apply(j,d),f||(e=h),"destroy"===b&&i.removeData("m_gantt")):j||(j=new c(i,b),i.data("m_gantt",j),j.render())}),e}});
//# sourceMappingURL=m_gantt.min.js.map